{% extends 'main/base.html' %}
{% load static %}

{% block title %}Inventory Report{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container d-flex">
  <nav class="sidebar text-white rounded-3 me-4 d-flex flex-column">
    {% if request.user.is_authenticated %}
    <div class="p-3 border-bottom">
      <span class="text-white">
        Welcome, <strong>{{ request.user.username }}</strong>
      </span>
    </div>
    {% endif %}

    <ul class="nav nav-pills flex-column gap-2 flex-grow-1 mt-3">
      <li class="nav-item">
        <a href="{% url 'main:dashboard_view' %}" class="nav-link text-white rounded-3 px-3 py-2">
          <i class="bi bi-bar-chart-fill me-2"></i> Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'product:products_list_view' %}" class="nav-link text-white rounded-3 px-3 py-2">
          <i class="bi bi-box-seam me-2"></i> Products
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'product:categories_list_view' %}" class="nav-link text-white rounded-3 px-3 py-2">
          <i class="bi bi-tags-fill me-2"></i> Categories
        </a>
      </li>
    </ul>

    <div class="mt-auto p-3 border-top">
      <a href="{% url 'main:logout_view' %}" class="nav-link text-white rounded-3 px-3 py-2">
        <i class="bi bi-box-arrow-right me-2"></i> Logout
      </a>
    </div>
  </nav>

  <main class="main-content flex-grow-1 p-4">
    <h2 class="mb-4">Inventory Report</h2>

    <div class="mb-4 d-flex gap-3">
      <a href="{% url 'product:export_csv_view' %}?category={{ selected_category }}&supplier={{ selected_supplier }}&status={{ selected_status }}" class="btn btn-success">
        <i class="bi bi-file-earmark-arrow-down"></i> Export CSV
      </a>
      <a href="{% url 'product:import_csv_view' %}" class="btn btn-primary">
        <i class="bi bi-file-earmark-arrow-up"></i> Import CSV
      </a>
    </div>

    <form method="GET" class="mb-4 d-flex flex-wrap gap-3 align-items-center">
      <select name="category" class="form-select" style="max-width: 200px;">
        <option value="">All Categories</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>

      <select name="supplier" class="form-select" style="max-width: 200px;">
        <option value="">All Suppliers</option>
        {% for sup in suppliers %}
          <option value="{{ sup.id }}" {% if selected_supplier == sup.id|stringformat:"s" %}selected{% endif %}>{{ sup.name }}</option>
        {% endfor %}
      </select>

      <select name="status" class="form-select" style="max-width: 200px;">
        <option value="">All Statuses</option>
        <option value="available" {% if selected_status == 'available' %}selected{% endif %}>Available</option>
        <option value="low_stock" {% if selected_status == 'low_stock' %}selected{% endif %}>Low Stock</option>
        <option value="out_of_stock" {% if selected_status == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
        <option value="discontinued" {% if selected_status == 'discontinued' %}selected{% endif %}>Discontinued</option>
      </select>

      <button type="submit" class="btn btn-primary px-4">Filter</button>
    </form>

    <div class="row g-3 mb-5">
      <div class="col-6 col-md-4 col-lg-2">
        <div class="card p-3 text-center">
          <h6 class="text-muted mb-1">Total Products</h6>
          <h4 class="fw-bold">{{ total_products }}</h4>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="card p-3 text-center">
          <h6 class="text-muted mb-1">Available</h6>
          <h4 class="fw-bold">{{ available_count }}</h4>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="card p-3 text-center">
          <h6 class="text-muted mb-1">Low Stock</h6>
          <h4 class="fw-bold">{{ low_stock_count }}</h4>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="card p-3 text-center">
          <h6 class="text-muted mb-1">Out of Stock</h6>
          <h4 class="fw-bold text-danger">{{ out_of_stock_count }}</h4>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="card p-3 text-center">
          <h6 class="text-muted mb-1">Discontinued</h6>
          <h4 class="fw-bold">{{ discontinued_count }}</h4>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="card p-3 text-center">
          <h6 class="text-muted mb-1">Expired</h6>
          <h4 class="fw-bold">{{ expired_count }}</h4>
        </div>
      </div>
    </div>

<div class="table-responsive">
  <table class="table table-striped table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Category</th>
        <th>Supplier</th>
        <th>Status</th>
        <th>Stock Quantity</th>
        <th>Expiry Date</th>
        <th>Price</th>
      </tr>
    </thead>
    <tbody>
      {% for product in products %}
      <tr {% if product.expiry_date and product.expiry_date < today %}class="table-danger"{% endif %}>
        <td>{{ forloop.counter }}</td>
        <td>{{ product.name }}</td>
        <td>
          {% if product.category %}
            {{ product.category.name }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if product.supplier %}
            {{ product.supplier.name }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ product.status }}</td>
        <td>{{ product.stock_quantity }}</td>
        <td>{{ product.expiry_date|date:"Y-m-d" }}</td>
        <td>{{ product.price }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8" class="text-center">No products found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card p-4 rounded-4 shadow-sm mt-4">
  <canvas id="inventoryChart" width="400" height="150"></canvas>
</div>
</main>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const availableCount = Number("{{ available_count|default:'0' }}");
  const lowStockCount = Number("{{ low_stock_count|default:'0' }}");
  const outOfStockCount = Number("{{ out_of_stock_count|default:'0' }}");
  const discontinuedCount = Number("{{ discontinued_count|default:'0' }}");
  const expiredCount = Number("{{ expired_count|default:'0' }}");

  const ctx = document.getElementById('inventoryChart').getContext('2d');
  const inventoryChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Available', 'Low Stock', 'Out of Stock', 'Discontinued', 'Expired'],
      datasets: [{
        label: 'Product Counts',
        data: [
          availableCount,
          lowStockCount,
          outOfStockCount,
          discontinuedCount,
          expiredCount
        ],
        backgroundColor: [
          'rgba(136, 97, 158, 0.7)',
          'rgba(190, 167, 185, 0.7)',
          'rgba(99, 8, 63, 0.7)',
          'rgba(201, 203, 207, 0.7)',
          'rgba(153, 102, 255, 0.7)'
        ],
        borderColor: [
          'rgba(136, 97, 158, 1)',
          'rgba(190, 167, 185, 1)',
          'rgba(99, 8, 63, 1)',
          'rgba(201, 203, 207, 1)',
          'rgba(153, 102, 255, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });
</script>
{% endblock %}
